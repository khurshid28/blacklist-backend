// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int           @id @default(autoincrement())
  image         String?
  sudlangan     Boolean       @default(false)
  name          String
  surname       String
  username      String        @unique
  birthdate     String        // Format: 08.10.2000
  phone         String        // Format: +998901234567
  pinfl         String        @db.VarChar(16)
  gender        Boolean       // true for male, false for female
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  phones        Phone[]
  cards         Card[]
  telegramUser  TelegramUser?
  comments      Comment[]
  videos        Video[]
  images        Image[]
  
  // Many-to-many relation for partners/associates
  partners      UserPartner[] @relation("UserToPartner")
  partneredBy   UserPartner[] @relation("PartnerToUser")
}

model UserPartner {
  id          Int      @id @default(autoincrement())
  userId      Int
  partnerId   Int
  createdAt   DateTime @default(now())
  
  user        User     @relation("UserToPartner", fields: [userId], references: [id], onDelete: Cascade)
  partner     User     @relation("PartnerToUser", fields: [partnerId], references: [id], onDelete: Cascade)
  
  @@unique([userId, partnerId])
  @@index([userId])
  @@index([partnerId])
}

model Phone {
  id        Int      @id @default(autoincrement())
  phone     String
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Card {
  id        Int      @id @default(autoincrement())
  bankName  String
  number    String
  expired   String   // Format: 0127
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TelegramUser {
  id          Int          @id @default(autoincrement())
  telegramId  BigInt       @unique
  phone       String
  firstName   String       @default("")
  lastName    String       @default("")
  fullname    String       @default("")
  username    String       @default("")
  userId      Int?         @unique
  user        User?        @relation(fields: [userId], references: [id])
  actionItems ActionItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model Video {
  id          Int      @id @default(autoincrement())
  title       String?
  description String?  @db.Text
  url         String   // Video fayl yo'li yoki URL
  duration    Int?     // Soniyalarda
  fileSize    Int?     // Baytlarda
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
}

model Image {
  id          Int      @id @default(autoincrement())
  title       String?
  description String?  @db.Text
  url         String   // Rasm fayl yo'li yoki URL
  fileSize    Int?     // Baytlarda
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
}

model Client {
  id          Int         @id @default(autoincrement())
  fullname    String
  phone       String      @unique // Format: +998901234567
  password    String      // 6 raqamli parol (hashed)
  image       String?
  workStatus  WorkStatus  @default(ACTIVE)
  role        ClientRole  @default(CLIENT)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  actions     Action[]
  
  @@index([phone])
}

model Action {
  id              Int           @id @default(autoincrement())
  clientId        Int
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  status          ActionStatus  @default(PENDING)
  startPhone      String        @default("+998900000000") // Boshlanish telefon raqami
  maxCount        Int           @default(10) // Maksimal 10 yoki 0 (SUPER uchun)
  processedCount  Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?
  
  items           ActionItem[]
  
  @@index([clientId])
  @@index([status])
}

model ActionItem {
  id              Int           @id @default(autoincrement())
  actionId        Int
  action          Action        @relation(fields: [actionId], references: [id], onDelete: Cascade)
  telegramUserId  Int?
  telegramUser    TelegramUser? @relation(fields: [telegramUserId], references: [id])
  phone           String
  createdAt       DateTime      @default(now())
  
  @@index([actionId])
  @@index([telegramUserId])
}

enum WorkStatus {
  ACTIVE
  BLOCKED
}

enum ClientRole {
  SUPER
  CLIENT
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}
